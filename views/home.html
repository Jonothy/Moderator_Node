<nav>
	<a class="active" href="./">Moderation</a>
	<a href="./stats">Stats</a>
</nav>

<!-- composite test -->
<!-- 	<div id="overlay-images">
		<img id="overlay-0" alt="composite source" src="img/sequence01.png"/>
	</div> -->
	
{{#if photo}}
	<canvas id="previewCanvas" width ="530" height="420"></canvas>
<!-- 	<img src="photos/{{photo.name}}" width="530" height="420" alt="Cat Picture" /> -->
	<div class="button-holder">
		<!-- <form action="./accepted" method="post">
			<input type="hidden" name="photo" value="{{photo.name}}" />
			<input type="submit" value="PUBLICLY ACCEPTABLE" />
		</form> -->
		<div id="moderation-action">
			<form action="./accepted" method="post">
				<input type="hidden" name="photo" value="{{photo.name}}" />
				<input type="button" id="btn-accept" value="PUBLICLY ACCEPTABLE" />
			</form>
			<form action="./declined" method="post">
				<input type="hidden" name="photo" value="{{photo.name}}" />
				<input type="submit" value="NOT" />
			</form>
		</div>
		<div id="image-submit">
			<!-- <form action="./accepted" id="data-submit" method="post" enctype="multipart/form-data"/> -->
			<form action="./saveProcessed" id="data-submit" name="data-submit" method="post"/>
			<!-- <div id="data-submit"> -->
				<input type="hidden" id="photo-name" name="photo" value="{{photo.name}}" />
				<input type="hidden" id="upload" name="upload" value="something"/>
				<!-- submit altered photo -->
				<input type="submit" id="btn-accept" value="SAVE IMAGE" />
			<!-- </div> -->
			</form>
		</div>
	</div>
	<div id="wrapper">
		<canvas id="hiddenCanvas"></canvas>
		<img id="imgtag" alt="capture"/>
	</div>

	

	<script src="js/support/jquery-2.1.3.min.js"></script>
	<script src="js/filters.js"></script>
	<script src="js/main.js"></script>
	<script>

		imageObj.src = "photos/{{photo.name}}";


		$("#data-submit").submit(function(e)
		{
		    var postData = 'photo=' + document.getElementById('photo-name').value;
		    // console.log(postData);
		    var canvasData = hiddenCanvas.toDataURL("image/png");
			postData += "&imgData=";
			postData +=canvasData.replace(/^data:image\/(png|jpg);base64,/, "");
			// console.log("postData");
			// console.log(postData);

		    $.ajax(
		    {
		        url : 'saveProcessed',
		        type: "POST",
		        data : postData,
		        success:function(data, textStatus, jqXHR) 
		        {
		        	//data: return data from server
		        	console.log("successful posting!");
		        	// console.log(data);

		        	if(data.photoName !== undefined && data.photoName !== null){
			        	var nameOfPhoto = data.photoName.name;
				        context.clearRect(0, 0, canvas.width, canvas.height);
				        hiddencontext.clearRect(0, 0, hiddencanvas.width, hiddencanvas.height);

				        imageObj.src = "photos/"+nameOfPhoto;

				        document.getElementById('photo-name').value = nameOfPhoto;

		        	}

		        	else{

		        		console.log("no more photos!");
		        	}
		        	document.getElementById('moderation-action').style.display = 'block';
    				document.getElementById('image-submit').style.display = 'none';
		            
		        },
		        error: function(jqXHR, textStatus, errorThrown) 
		        {
		        	console.log("unsuccesful");
		        	console.log(data);
		            //if fails      
		        }
		    });
		    e.preventDefault(); //STOP default action
		    // e.unbind(); //unbind. to stop multiple form submit.
		});
		 
		// $("#data-submit").submit();

		// $(document).ready(function () {
		    // $('#data-submit').submit(function () {
		    //     // var formData = new FormData($('form')[0]);
		    //     // console.log(saveObj);
		    //     // console.log(saveObj.src);

		    //     console.log("submitted");
		    //     // function saveImage() {
				    // var canvasData = hiddenCanvas.toDataURL("image/png");
				    // var dataSend = "imgData=";
				    // dataSend+=canvasData.replace(/^data:image\/(png|jpg);base64,/, "");
				  //   dataSend+="&photoName=";
				  //   dataSend+="{{photo.name}}";
				  //   console.log("canvas data");
				  //   console.log(canvasData);
				  //   var xmlHttpReq = false;       
				  //   if (window.XMLHttpRequest) {
				  //       ajax = new XMLHttpRequest();
				  //   }

				  //  ajax.open('POST', 'saveProcessed', false);
				  //  ajax.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				  //  ajax.onreadystatechange = function() {
				  //       console.log(ajax.responseText);
				  //    	var parsed_data = JSON.parse(ajax.responseText);
				  //    	console.log(parsed_data.photoName);
				  //   }
				  //  ajax.send(dataSend);
				// }


		        // var formData = new FormData();
		        // formData.append('photo', 'butts');
		        // // formData.append('upload', saveObj);
		        // console.log(formData);
		        // // $('#response').html("<b>Loading response...</b>");
		        // $.ajax({
		        //     url: 'newImage',  //Server script to process data
		        //     type: 'POST',
		        //     data: formData,
		        //     async: false,
		        //     success: function (msg) {
		        //     	alert("success");
		        //         // $('#response').html(msg);
		        //     },
		        //     cache: false,
		        //     // contentType: false,
		        //     contentType: true,
		        //     processData: false
		        // });
		        // this.reset();
		        // return false;
		    // });
		// });
	</script>

{{else}}

	<h3>No more photos to vote on! Check out the <a href="./stats">stats</a>.</h3>

{{/if}}